name: build

on:
  - push
  - pull_request

jobs:
  build:
    name: Build
    runs-on: ${{ matrix.os }}
    env:
      NAME: yuki
      GO111MODULE: on
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            # GitHub Actions only provides amd64 arch now.
            GOOS: linux
            GOARCH: amd64

    services:
      mongodb:
        image: mongo:3
        ports:
          - 27017:27017

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Go 1.x
      uses: actions/setup-go@v4
      with:
        go-version: ^1.20

    - name: Get dependencies
      run: |
        go get -v -t -d ./...
        if [ -f Gopkg.toml ]; then
          curl -s https://raw.githubusercontent.com/golang/dep/master/install.sh | sh
          dep ensure
        fi

    - name: Test
      run: |
        docker pull ustcmirror/test
        ci/script.sh

    - name: Deploy - Build
      if: startsWith(github.ref, 'refs/tags/')
      run: ci/build.sh
      env:
        GOOS: ${{ matrix.GOOS }}
        GOARCH: ${{ matrix.GOARCH }}

    - name: Deploy - Release
      if: startsWith(github.ref, 'refs/tags/')
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: ${{ github.ref_name }}
        files: ${{ env.NAME }}-*.tar.gz
        draft: false
        prerelease: false
